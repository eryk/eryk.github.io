<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="cn">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Python量化交易实战">
<meta property="og:url" content="http://xuqi365.com/page/2/index.html">
<meta property="og:site_name" content="Python量化交易实战">
<meta property="og:locale" content="cn">
<meta property="article:author" content="eryk">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://xuqi365.com/page/2/"/>





  <title>Python量化交易实战</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="cn">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Python量化交易实战</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/04/26/2019-04-26%20%E5%A4%84%E7%90%86linux%E7%B3%BB%E7%BB%9F%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/26/2019-04-26%20%E5%A4%84%E7%90%86linux%E7%B3%BB%E7%BB%9F%E5%83%B5%E5%B0%B8%E8%BF%9B%E7%A8%8B/" itemprop="url">处理linux系统僵尸进程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-26T15:36:00+08:00">
                2019-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">系统运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在使用jupyter运行多进程程序时，发现重启jupyter notebook偶尔会留下一些僵尸进程，应该是python父进程被终止之后子进程没有被正确释放造成的。僵尸进程依然会占用系统资源，如果不及时清理可能会严重影响系统性能。</p>
<p>先解释下什么是僵尸进程</p>
<blockquote>
<p>僵尸进程是当子进程比父进程先结束，而父进程又没有回收子进程，释放子进程占用的资源，此时子进程将成为一个僵尸进程。如果父进程先退出 ，子进程被init接管，子进程退出后init会回收其占用的相关资源。</p>
<p>在UNIX 系统中，一个进程结束了，但是他的父进程没有等待(调用wait / waitpid)他， 那么他将变成一个僵尸进程。<br>                                                                                                                       — 百度百科</p>
</blockquote>
<p> 在jupyter中使用多进程执行程序时，如果程序还没有执行完成就点击菜单栏的 Kernel -&gt; Restart xxx，就有可能会造成僵尸进程。</p>
<p>如何检查僵尸进程是否存在呢？在命令行中执行如下命令就可以返回僵尸进程状态、父进程ID、进程ID和执行的具体命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -A -ostat,ppid,pid,cmd | grep -e '^[Zz]'</span><br></pre></td></tr></table></figure>

<p>杀死僵尸进程也比较容易，执行如下命令就可以清理僵尸进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 `ps -A -ostat,ppid,pid,cmd | grep -e '^[Zz]' | awk '&#123;print $2&#125;'`</span><br></pre></td></tr></table></figure>

<p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/04/24/%E4%BD%BF%E7%94%A8Pandas%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E5%9D%87%E7%BA%BF%E7%AD%96%E7%95%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/24/%E4%BD%BF%E7%94%A8Pandas%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E5%9D%87%E7%BA%BF%E7%AD%96%E7%95%A5/" itemprop="url">使用Pandas开发一个均线策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-24T20:47:00+08:00">
                2019-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AD%96%E7%95%A5%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index">
                    <span itemprop="name">策略研究</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<p>大家好，这篇文章我将使用Pandas创建一个简单的均线交叉策略，以500ETF作为标的物进行回测</p>
<p>移动平均线可能是技术指标里的”hello world”了，常用的均线有5、10、20、60、120日均线，在其他时间周期上应用移动平均线指标也是类似方式。</p>
<p>移动平均线按时间周期长短分为：短期移动平均线，中期移动平均线，长期移动平均线；按计算方法分为：算术移动平均线，加权移动平均线，指数平滑移动平均线（EMA）</p>
<p>下面正式开始编写策略代码，我们使用jupyer作为研究环境，首先先导入依赖模块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line"></span><br><span class="line">%matplotlib inline</span><br></pre></td></tr></table></figure>

<p>接下来使用tushare下载500ETF的历史数据，500ETF是从2013年开始上市交易的，这里将start参数设置为2013，这样可以获取500ETF的全部历史数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">etf500 = ts.get_k_data(<span class="string">'510500'</span>,start=<span class="string">'2013'</span>)</span><br><span class="line">etf500.set_index(pd.to_datetime(etf500[<span class="string">'date'</span>]),inplace=<span class="literal">True</span>) </span><br><span class="line"><span class="keyword">del</span> etf500[<span class="string">'date'</span>]</span><br><span class="line">etf500.head()</span><br></pre></td></tr></table></figure>

<p>输出结果如下，数据是从2013年3月15日开始的：</p>
<table>
<thead>
<tr>
<th align="right">date</th>
<th align="right">open</th>
<th align="right">close</th>
<th align="right">high</th>
<th align="right">low</th>
<th align="right">volume</th>
<th align="right">code</th>
</tr>
</thead>
<tbody><tr>
<td align="right">2013-03-15</td>
<td align="right">0.967</td>
<td align="right">0.970</td>
<td align="right">0.985</td>
<td align="right">0.955</td>
<td align="right">3259273.0</td>
<td align="right">510500</td>
</tr>
<tr>
<td align="right">2013-03-18</td>
<td align="right">0.955</td>
<td align="right">0.954</td>
<td align="right">0.972</td>
<td align="right">0.953</td>
<td align="right">936962.0</td>
<td align="right">510500</td>
</tr>
<tr>
<td align="right">2013-03-19</td>
<td align="right">0.956</td>
<td align="right">0.960</td>
<td align="right">0.960</td>
<td align="right">0.941</td>
<td align="right">1080499.0</td>
<td align="right">510500</td>
</tr>
<tr>
<td align="right">2013-03-20</td>
<td align="right">0.960</td>
<td align="right">0.985</td>
<td align="right">0.986</td>
<td align="right">0.958</td>
<td align="right">501195.0</td>
<td align="right">510500</td>
</tr>
<tr>
<td align="right">2013-03-21</td>
<td align="right">0.985</td>
<td align="right">0.995</td>
<td align="right">0.996</td>
<td align="right">0.981</td>
<td align="right">698243.0</td>
<td align="right">510500</td>
</tr>
</tbody></table>
<p>继续画出收盘价格曲线，对500ETF走势有个大概的了解。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etf500[<span class="string">'close'</span>].plot(grid=<span class="literal">True</span>, figsize=(<span class="number">8</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190423172643.png" alt=""></p>
<p>接下来是双均线策略的实现，我们使用20日均线和60日均线作为短期和长期均线，下面先分别计算20日和60日均线序列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etf500[<span class="string">'ma20'</span>] = etf500[<span class="string">'close'</span>].rolling(<span class="number">20</span>).mean()</span><br><span class="line">etf500[<span class="string">'ma60'</span>] = etf500[<span class="string">'close'</span>].rolling(<span class="number">60</span>).mean()</span><br><span class="line">etf500[[<span class="string">'close'</span>,<span class="string">'ma20'</span>,<span class="string">'ma60'</span>]].plot(grid=<span class="literal">True</span>, figsize=(<span class="number">14</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190423174737.png" alt=""></p>
<p>我们已经获取了两条移动平均线序列，接下来是根据均线来生成交易信号</p>
<p>策略信号会有两种状态： </p>
<ol>
<li><p>买入信号，当20日均线向上穿过60日均线时持有多头仓位</p>
</li>
<li><p>卖出信号，当20日均线向下穿过60日均线时平仓</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">etf500[<span class="string">'Stance'</span>] = np.where(etf500[<span class="string">'ma20'</span>] - etf500[<span class="string">'ma60'</span>] &gt; <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">etf500[<span class="string">'Stance'</span>].value_counts()</span><br></pre></td></tr></table></figure>

<p>最后一行统计持仓和空仓的天数，输出结果如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>    <span class="number">761</span></span><br><span class="line"><span class="number">0</span>    <span class="number">724</span></span><br><span class="line">Name: Stance, dtype: int64</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etf500[<span class="string">'Stance'</span>].plot(ylim=[<span class="number">-0.1</span>,<span class="number">1.1</span>])</span><br></pre></td></tr></table></figure>

<p>下图显示持仓日期数据</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190423223738.png" alt=""></p>
<p>接下来，我们根据持仓数据来计算持仓的收益</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">etf500[<span class="string">'Market Returns'</span>] = np.log(etf500[<span class="string">'close'</span>] / etf500[<span class="string">'close'</span>].shift(<span class="number">1</span>))</span><br><span class="line">etf500[<span class="string">'Strategy'</span>] = etf500[<span class="string">'Market Returns'</span>] * etf500[<span class="string">'Stance'</span>].shift(<span class="number">1</span>)</span><br><span class="line">etf500[[<span class="string">'Market Returns'</span>,<span class="string">'Strategy'</span>]].cumsum().plot(grid=<span class="literal">True</span>,figsize=(<span class="number">8</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190423225315.png" alt=""></p>
<p>以上图片展示了市场回报率与策略回报曲线，可以看到20和60日双均线策略并没有跑赢500ETF，不过我们也可以测试下其他均线组合，也许会有不错的效果。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.pythonforfinance.net/2016/09/01/moving-average-crossover-trading-strategy-backtest-in-python/#more-15498&gt;" target="_blank" rel="noopener">https://www.pythonforfinance.net/2016/09/01/moving-average-crossover-trading-strategy-backtest-in-python/#more-15498&gt;</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/04/22/2019-04-22%20Multiprocessing%20Pipe%E5%92%8CQueue%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/22/2019-04-22%20Multiprocessing%20Pipe%E5%92%8CQueue%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" itemprop="url">Multiprocessing Pipe和Queue性能测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-22T10:47:00+08:00">
                2019-04-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>开发股票行情推送的引擎时遇到一个问题，在9:30开盘后的一段时间内行情消息总是堆积，尤其是开头15-20分钟，堆积的数据量会越来越多，经过debug发现是内部消息传输使用Queue性能问题导致了消息延迟，在stackoverflow上找到一个帖子对Queue的性能进行了测试和解释说明，下面先来介绍下Multiprocessing下的Queue和Pipe</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>当使用多个进程时，通常使用消息传递来进行进程之间的通信，为了不损耗性能也会尽量避免使用同步机制。对于消息传递：</p>
<pre><code>* Pipe适用于两个进程间的消息传递。
* Queue适用于多个进程间的消息传递，适用于多生产者和消费者的模式。</code></pre><h1 id="Pipe-VS-Queue"><a href="#Pipe-VS-Queue" class="headerlink" title="Pipe VS Queue"></a>Pipe VS Queue</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Pipe</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reader_proc</span><span class="params">(pipe)</span>:</span></span><br><span class="line">    <span class="comment">## Read from the pipe; this will be spawned as a separate Process</span></span><br><span class="line">    p_output, p_input = pipe</span><br><span class="line">    p_input.close()  <span class="comment"># We are only reading</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        msg = p_output.recv()  <span class="comment"># Read from the output pipe and do nothing</span></span><br><span class="line">        <span class="keyword">if</span> msg == <span class="string">'DONE'</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writer</span><span class="params">(count, p_input)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(<span class="number">0</span>, count):</span><br><span class="line">        p_input.send(ii)  <span class="comment"># Write 'count' numbers into the input pipe</span></span><br><span class="line">    p_input.send(<span class="string">'DONE'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> [<span class="number">10</span> ** <span class="number">4</span>, <span class="number">10</span> ** <span class="number">5</span>, <span class="number">10</span> ** <span class="number">6</span>]:</span><br><span class="line">        <span class="comment"># Pipes are unidirectional with two endpoints:  p_input ------&gt; p_output</span></span><br><span class="line">        p_output, p_input = Pipe()  <span class="comment"># writer() writes to p_input from _this_ process</span></span><br><span class="line">        reader_p = Process(target=reader_proc, args=((p_output, p_input),))</span><br><span class="line">        reader_p.daemon = <span class="literal">True</span></span><br><span class="line">        reader_p.start()  <span class="comment"># Launch the reader process</span></span><br><span class="line"></span><br><span class="line">        p_output.close()  <span class="comment"># We no longer need this part of the Pipe()</span></span><br><span class="line">        _start = time.time()</span><br><span class="line">        writer(count, p_input)  <span class="comment"># Send a lot of stuff to reader_proc()</span></span><br><span class="line">        p_input.close()</span><br><span class="line">        reader_p.join()</span><br><span class="line">        print(<span class="string">"Sending &#123;0&#125; numbers to Pipe() took &#123;1&#125; seconds"</span>.format(count,</span><br><span class="line">                                                                      (time.time() - _start)))</span><br></pre></td></tr></table></figure>

<h3 id="Pipe输出结果"><a href="#Pipe输出结果" class="headerlink" title="Pipe输出结果"></a>Pipe输出结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sending 10000 numbers to Pipe() took 0.0744009017944336 seconds</span><br><span class="line">Sending 100000 numbers to Pipe() took 0.7794349193572998 seconds</span><br><span class="line">Sending 1000000 numbers to Pipe() took 7.425454139709473 seconds</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reader_proc</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="comment">## Read from the queue; this will be spawned as a separate Process</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        msg = queue.get()  <span class="comment"># Read from the queue and do nothing</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="string">'DONE'</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writer</span><span class="params">(count, queue)</span>:</span></span><br><span class="line">    <span class="comment">## Write to the queue</span></span><br><span class="line">    <span class="keyword">for</span> ii <span class="keyword">in</span> range(<span class="number">0</span>, count):</span><br><span class="line">        queue.put(ii)  <span class="comment"># Write 'count' numbers into the queue</span></span><br><span class="line">    queue.put(<span class="string">'DONE'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pqueue = Queue()  <span class="comment"># writer() writes to pqueue from _this_ process</span></span><br><span class="line">    <span class="keyword">for</span> count <span class="keyword">in</span> [<span class="number">10</span> ** <span class="number">4</span>, <span class="number">10</span> ** <span class="number">5</span>, <span class="number">10</span> ** <span class="number">6</span>]:</span><br><span class="line">        <span class="comment">### reader_proc() reads from pqueue as a separate process</span></span><br><span class="line">        reader_p = Process(target=reader_proc, args=((pqueue),))</span><br><span class="line">        reader_p.daemon = <span class="literal">True</span></span><br><span class="line">        reader_p.start()  <span class="comment"># Launch reader_proc() as a separate python process</span></span><br><span class="line"></span><br><span class="line">        _start = time.time()</span><br><span class="line">        writer(count, pqueue)  <span class="comment"># Send a lot of stuff to reader()</span></span><br><span class="line">        reader_p.join()  <span class="comment"># Wait for the reader to finish</span></span><br><span class="line">        print(<span class="string">"Sending &#123;0&#125; numbers to Queue() took &#123;1&#125; seconds"</span>.format(count,</span><br><span class="line">                                                                       (time.time() - _start)))</span><br></pre></td></tr></table></figure>

<h4 id="Queue-输出结果"><a href="#Queue-输出结果" class="headerlink" title="Queue 输出结果"></a>Queue 输出结果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sending 10000 numbers to Queue() took 0.2558887004852295 seconds</span><br><span class="line">Sending 100000 numbers to Queue() took 2.4320709705352783 seconds</span><br><span class="line">Sending 1000000 numbers to Queue() took 23.602338075637817 seconds</span><br></pre></td></tr></table></figure>

<p>让我们把结果整理成表格方便对比查看:</p>
<table>
<thead>
<tr>
<th align="right">循环次数</th>
<th align="right">Pipe</th>
<th align="right">Queue</th>
</tr>
</thead>
<tbody><tr>
<td align="right">10000</td>
<td align="right">0.0744</td>
<td align="right">0.2558</td>
</tr>
<tr>
<td align="right">100000</td>
<td align="right">0.7794</td>
<td align="right">2.4320</td>
</tr>
<tr>
<td align="right">1000000</td>
<td align="right">7.4254</td>
<td align="right">23.6023</td>
</tr>
</tbody></table>
<p>通过对比测试可以发现，Pipe性能大约为Queue的3倍，所以在仅有两端通信的情况下应该优先使用Pipe。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>通过阅读Queue的源码，我们可以发现，其实在Queue内部是用Lock来实现对Pipe的安全读写操作的。所以相比于Pipe会有额外的锁的开销。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, maxsize=<span class="number">0</span>, *, ctx)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> maxsize &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Can raise ImportError (see issues #3770 and #23400)</span></span><br><span class="line">            <span class="keyword">from</span> .synchronize <span class="keyword">import</span> SEM_VALUE_MAX <span class="keyword">as</span> maxsize</span><br><span class="line">        self._maxsize = maxsize</span><br><span class="line">        self._reader, self._writer = connection.Pipe(duplex=<span class="literal">False</span>) <span class="comment"># 这里初始化了Pipe对象</span></span><br><span class="line">        self._rlock = ctx.Lock()</span><br><span class="line">        self._opid = os.getpid()</span><br><span class="line">        <span class="keyword">if</span> sys.platform == <span class="string">'win32'</span>:</span><br><span class="line">            self._wlock = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._wlock = ctx.Lock()</span><br><span class="line">        self._sem = ctx.BoundedSemaphore(maxsize)</span><br><span class="line">        <span class="comment"># For use by concurrent.futures</span></span><br><span class="line">        self._ignore_epipe = <span class="literal">False</span></span><br><span class="line">        self._after_fork()</span><br><span class="line">        <span class="keyword">if</span> sys.platform != <span class="string">'win32'</span>:</span><br><span class="line">            register_after_fork(self, Queue._after_fork)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, obj, block=True, timeout=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._closed:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Queue <span class="subst">&#123;self!r&#125;</span> is closed"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._sem.acquire(block, timeout):</span><br><span class="line">            <span class="keyword">raise</span> Full</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> self._notempty:</span><br><span class="line">            <span class="keyword">if</span> self._thread <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self._start_thread()</span><br><span class="line">            self._buffer.append(obj)</span><br><span class="line">            self._notempty.notify()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, block=True, timeout=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._closed:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Queue <span class="subst">&#123;self!r&#125;</span> is closed"</span>)</span><br><span class="line">        <span class="keyword">if</span> block <span class="keyword">and</span> timeout <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">with</span> self._rlock:</span><br><span class="line">                res = self._recv_bytes()</span><br><span class="line">            self._sem.release()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> block:</span><br><span class="line">                deadline = time.monotonic() + timeout</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._rlock.acquire(block, timeout):</span><br><span class="line">                <span class="keyword">raise</span> Empty</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> block:</span><br><span class="line">                    timeout = deadline - time.monotonic()</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> self._poll(timeout):</span><br><span class="line">                        <span class="keyword">raise</span> Empty</span><br><span class="line">                <span class="keyword">elif</span> <span class="keyword">not</span> self._poll():</span><br><span class="line">                    <span class="keyword">raise</span> Empty</span><br><span class="line">                res = self._recv_bytes()</span><br><span class="line">                self._sem.release()</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self._rlock.release()</span><br><span class="line">        <span class="comment"># unserialize the data after having released the lock</span></span><br><span class="line">        <span class="keyword">return</span> _ForkingPickler.loads(res)</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://stackoverflow.com/questions/8463008/multiprocessing-pipe-vs-queue" target="_blank" rel="noopener">https://stackoverflow.com/questions/8463008/multiprocessing-pipe-vs-queue</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/04/19/2019-04-19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/19/2019-04-19/" itemprop="url">virtualenv 使用教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-19T16:38:00+08:00">
                2019-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<p>virtualenv是python虚拟软件环境的管理工具，用于创建和删除虚拟环境</p>
<h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ol>
<li>隔离性，将python软件环境打包安装到单独的目录下，可以以项目或者脚本为单位单独创建虚拟环境，防止项目间模块版本混乱和冲突的问题。</li>
<li>易用性，通过一行命令即可创建虚拟环境，在虚拟环境之间切换也非常简单</li>
</ol>
<h3 id="安装virtualenv"><a href="#安装virtualenv" class="headerlink" title="安装virtualenv"></a>安装virtualenv</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br></pre></td></tr></table></figure>

<h3 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtualenv --help</span><br></pre></td></tr></table></figure>
<p>比较有用的几个参数：</p>
<ul>
<li>-p PYTHON_EXE, –python=PYTHON_EXE，指定虚拟环境中的python版本</li>
<li>–system-site-packages， 创建的虚拟环境将使用连接的方式，添加系统默认python环境中的site-packages</li>
<li>–always-copy，使用copy的方式代替连接来添加系统默认python已安装模块</li>
</ul>
<h3 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir myproject</span><br><span class="line">cd myproject</span><br><span class="line">virtualenv --p python3.6 venv</span><br></pre></td></tr></table></figure>

<h3 id="激活和退出虚拟环境"><a href="#激活和退出虚拟环境" class="headerlink" title="激活和退出虚拟环境"></a>激活和退出虚拟环境</h3><p>激活虚拟环境，系统激活之后，提示符前端有个(venv)的前缀，表示系统已经切换到venv虚拟环境目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source venv&#x2F;bin&#x2F;activate</span><br></pre></td></tr></table></figure>
<p>在venv环境下，安装模块可以使用pip来进行</p>
<p>退出虚拟环境，退出后系统将自动选择系统默认的Python解释器，提示符前缀的(venv)也会消失</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<h3 id="删除虚拟环境"><a href="#删除虚拟环境" class="headerlink" title="删除虚拟环境"></a>删除虚拟环境</h3><p>由于每个虚拟环境是独立部署的，所以直接将虚拟环境目录rm就可以完成清理</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>virtualenvwrapper是virtualenv的扩展管理包，用于更方便管理虚拟环境，它可以做：</p>
<ul>
<li>将所有虚拟环境整合在一个目录下</li>
<li>管理（新增，删除，复制）虚拟环境</li>
<li>切换虚拟环境</li>
</ul>
<p>另外，从python3.3之后，virtualenv已经作为python模块venv提供使用，具体信息可以参考一下网址：</p>
<blockquote>
<p><a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noopener">https://docs.python.org/3/library/venv.html</a></p>
</blockquote>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://virtualenv.pypa.io/en/latest/" target="_blank" rel="noopener">https://virtualenv.pypa.io/en/latest/</a></li>
<li><a href="https://virtualenvwrapper.readthedocs.io/en/latest/" target="_blank" rel="noopener">https://virtualenvwrapper.readthedocs.io/en/latest/</a></li>
<li><a href="https://segmentfault.com/a/1190000012030061" target="_blank" rel="noopener">https://segmentfault.com/a/1190000012030061</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432712108300322c61f256c74803b43bfd65c6f8d0d0000" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001432712108300322c61f256c74803b43bfd65c6f8d0d0000</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/03/22/2019-03-22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/22/2019-03-22/" itemprop="url">创建docker ftp服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-22T15:17:00+08:00">
                2019-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">系统运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<p>使用的docker镜像是 <a href="https://github.com/stilliard/docker-pure-ftpd" target="_blank" rel="noopener">https://github.com/stilliard/docker-pure-ftpd</a></p>
<p>创建步骤如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull stilliard/pure-ftpd:hardened</span><br><span class="line"></span><br><span class="line">docker run -d -e FTP_USER_NAME=test -e FTP_USER_PASS=test --name ftpd_server -p 21:21 -e FTP_PASSIVE_PORTS=45020:45100 --expose=45020-45100 -p 45020-45100:45020-45100 -v /home/test:/home/ftpusers -e "PUBLICHOST=10.168.2.178" -e FTP_USER_HOME=/home/ftpusers stilliard/pure-ftpd:hardened</span><br></pre></td></tr></table></figure>

<p>注意：FileZilla传输模式需要选择“主动”</p>
<p>提供的参数解释说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;sbin&#x2F;pure-ftpd # path to pure-ftpd executable</span><br><span class="line">-c 5 # --maxclientsnumber (no more than 5 people at once)</span><br><span class="line">-C 5 # --maxclientsperip (no more than 5 requests from the same ip)</span><br><span class="line">-l puredb:&#x2F;etc&#x2F;pure-ftpd&#x2F;pureftpd.pdb # --login (login file for virtual users)</span><br><span class="line">-E # --noanonymous (only real users)</span><br><span class="line">-j # --createhomedir (auto create home directory if it doesnt already exist)</span><br><span class="line">-R # --nochmod (prevent usage of the CHMOD command)</span><br><span class="line">-P $PUBLICHOST # IP&#x2F;Host setting for PASV support, passed in your the PUBLICHOST env var</span><br><span class="line">-p 30000:30009 # PASV port range (10 ports for 5 max clients)</span><br><span class="line">-tls 1 # Enables optional TLS support</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2019/03/15/2019-03-15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/15/2019-03-15/" itemprop="url">ufw防火墙使用常用命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-15T09:38:00+08:00">
                2019-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">系统运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="开启-关闭ufw"><a href="#开启-关闭ufw" class="headerlink" title="开启/关闭ufw"></a>开启/关闭ufw</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ufw enable</span><br><span class="line">ufw disable</span><br></pre></td></tr></table></figure>

<h3 id="允许某端口被访问"><a href="#允许某端口被访问" class="headerlink" title="允许某端口被访问"></a>允许某端口被访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow 80</span><br></pre></td></tr></table></figure>

<h3 id="禁止某端口被访问"><a href="#禁止某端口被访问" class="headerlink" title="禁止某端口被访问"></a>禁止某端口被访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw deny 8888</span><br></pre></td></tr></table></figure>

<h3 id="添加规则"><a href="#添加规则" class="headerlink" title="添加规则"></a>添加规则</h3><p>允许10.168.2.137访问30004端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow from 10.168.2.137 to any port 30004</span><br></pre></td></tr></table></figure>

<h3 id="插入规则"><a href="#插入规则" class="headerlink" title="插入规则"></a>插入规则</h3><p>在第二条位置插入规则，允许192.168.1.1访问8888端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw insert 2 allow from 192.168.1.1 to any port 8888</span><br></pre></td></tr></table></figure>


<h3 id="按编号显示规则"><a href="#按编号显示规则" class="headerlink" title="按编号显示规则"></a>按编号显示规则</h3><blockquote>
<p>ufw status numbered</p>
</blockquote>
<h3 id="按编号删除规则"><a href="#按编号删除规则" class="headerlink" title="按编号删除规则"></a>按编号删除规则</h3><blockquote>
<p>ufw delete 编号</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2018/12/19/2018-12-18/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/19/2018-12-18/" itemprop="url">Python异常处理伴侣 -- tenacity模块使用介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-19T11:15:00+08:00">
                2018-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<p>在写代码时经常会遇到对抛出异常的代码进行重试，常见于网页爬虫的代码中，使用计数器 + 循环的方式对抛出异常的代码进行捕获和重试。tenacity是使用Python装饰器模式对方法异常进行捕获，通过灵活的参数实现简单优雅的异常重试。</p>
<h1 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h1><ol>
<li>简单灵活的装饰模式api</li>
<li>可以指定重试停止条件（比如：设置重试次数）</li>
<li>也可以指定等待条件（比如：使用指数避让间隔重试）</li>
<li>自定义触发重试的Exception</li>
<li>自定义重试预期的返回结果</li>
<li>基于协程的重试</li>
</ol>
<h1 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式:"></a>安装方式:</h1><blockquote>
<p>pip install tenacity</p>
</blockquote>
<h1 id="API使用介绍"><a href="#API使用介绍" class="headerlink" title="API使用介绍"></a>API使用介绍</h1><h3 id="1-retry"><a href="#1-retry" class="headerlink" title="1. @retry"></a>1. @retry</h3><p>给需要重试的方法加上@retry修饰器之后，方法抛出异常就会被装饰器捕获到并进行重试，异常抛出时会不断重试直到方法成功返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">never_give_up_never_surrender</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Retry forever ignoring Exceptions, don't wait between retries"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<h3 id="2-带终止条件的retry"><a href="#2-带终止条件的retry" class="headerlink" title="2. 带终止条件的retry"></a>2. 带终止条件的retry</h3><p>我们也可以给retry加一个参数设置重试n次后不再重试并抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(stop=stop_after_attempt(7))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_after_7_attempts</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Stopping after 7 attempts"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<p>使用@stop_after_delay 可以指定重试间隔，比如如下的例子指定10秒后重试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(stop=stop_after_delay(10))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_after_10_s</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Stopping after 10 seconds"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<p>可以使用 “|” 把多个条件组合起来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(stop=(stop_after_delay(10) | stop_after_attempt(5)))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_after_10_s_or_5_retries</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Stopping after 10 seconds or 5 retries"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<h3 id="3-在重试前等待"><a href="#3-在重试前等待" class="headerlink" title="3. 在重试前等待"></a>3. 在重试前等待</h3><p>使用@wait_fixed 在重试前等待固定时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(wait=wait_fixed(2))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wait_2_s</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Wait 2 second between retries"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<p>随机等待1-2秒钟，这在爬虫爬网页时比较有用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(wait=wait_random(min=1, max=2))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wait_random_1_to_2_s</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Randomly wait 1 to 2 seconds between retries"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<p>增加指数避让等待间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(wait=wait_exponential(multiplier=1, min=4, max=10))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wait_exponential_1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Wait 2^x * 1 second between each retry starting with 4 seconds, then up to 10 seconds, then 10 seconds afterwards"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br><span class="line">    </span><br><span class="line"><span class="meta">@retry(wait=wait_fixed(3) + wait_random(0, 2))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wait_fixed_jitter</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Wait at least 3 seconds, and add up to 2 seconds of random delay"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<p>看一个更复杂点的例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(wait=wait_chain(*[wait_fixed(3) for i in range(3)] +</span></span><br><span class="line">                       [wait_fixed(<span class="number">7</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>)] +</span><br><span class="line">                       [wait_fixed(<span class="number">9</span>)]))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wait_fixed_chained</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Wait 3s for 3 attempts, 7s for the next 2 attempts and 9s for all attempts thereafter"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br></pre></td></tr></table></figure>

<h3 id="4-带触发条件的retry语句"><a href="#4-带触发条件的retry语句" class="headerlink" title="4. 带触发条件的retry语句"></a>4. 带触发条件的retry语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(retry=retry_if_exception_type(IOError))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">might_io_error</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Retry forever with no wait if an IOError occurs, raise any other errors"</span>)</span><br><span class="line">    <span class="keyword">raise</span> Exception</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_none_p</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="string">"""Return True if value is None"""</span></span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">is</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@retry(retry=retry_if_result(is_none_p))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">might_return_none</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Retry with no wait if return value is None"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@retry(retry=(retry_if_result(is_none_p) | retry_if_exception_type()))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">might_return_none</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"Retry forever ignoring Exceptions with no wait if return value is None"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-异常处理"><a href="#5-异常处理" class="headerlink" title="5. 异常处理"></a>5. 异常处理</h3><p> 虽然tenacity会帮我们处理异常，我们依然可以在重试失败后使用reraise来决定我们时候进行最后的尝试，使用reraise会把异常抛出交给我们的try except来处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(reraise=True, stop=stop_after_attempt(3))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_my_exception</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> MyException(<span class="string">"Fail"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    raise_my_exception()</span><br><span class="line"><span class="keyword">except</span> MyException:</span><br><span class="line">    <span class="comment"># timed out retrying</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h3 id="6-在retry前后增加log"><a href="#6-在retry前后增加log" class="headerlink" title="6. 在retry前后增加log"></a>6. 在retry前后增加log</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@retry(stop=stop_after_attempt(3), before=before_log(logger, logging.DEBUG))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_my_exception</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> MyException(<span class="string">"Fail"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@retry(stop=stop_after_attempt(3), after=after_log(logger, logging.DEBUG))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_my_exception</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> MyException(<span class="string">"Fail"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@retry(stop=stop_after_attempt(3),</span></span><br><span class="line">       before_sleep=before_sleep_log(logger, logging.DEBUG))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_my_exception</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> MyException(<span class="string">"Fail"</span>)</span><br></pre></td></tr></table></figure>

<h3 id="7-统计异常情况"><a href="#7-统计异常情况" class="headerlink" title="7. 统计异常情况"></a>7. 统计异常情况</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@retry(stop=stop_after_attempt(3))</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raise_my_exception</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">raise</span> MyException(<span class="string">"Fail"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    raise_my_exception()</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">print(raise_my_exception.retry.statistics)</span><br></pre></td></tr></table></figure>
<p>输出如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#39;start_time&#39;: 283085.571804807, &#39;attempt_number&#39;: 3, &#39;idle_for&#39;: 0, &#39;delay_since_first_attempt&#39;: 0.0002240639878436923&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-自定义异常回调函数"><a href="#8-自定义异常回调函数" class="headerlink" title="8. 自定义异常回调函数"></a>8. 自定义异常回调函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tenacity <span class="keyword">import</span> stop_after_attempt, retry_if_result, retry</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">return_last_value</span><span class="params">(retry_state)</span>:</span></span><br><span class="line">    <span class="string">"""return the result of the last call attempt"""</span></span><br><span class="line">    <span class="keyword">return</span> retry_state.result()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_false</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="string">"""Return True if value is False"""</span></span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">is</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># will return False after trying 3 times to get a different result</span></span><br><span class="line"><span class="meta">@retry(stop=stop_after_attempt(3),</span></span><br><span class="line">       retry_error_callback=return_last_value,</span><br><span class="line">       retry=retry_if_result(is_false))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eventually_return_false</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">print(eventually_return_false())</span><br></pre></td></tr></table></figure>
<p>输出结果为 False</p>
<h1 id="项目Git地址"><a href="#项目Git地址" class="headerlink" title="项目Git地址"></a>项目Git地址</h1><p><a href="https://github.com/jd/tenacity" target="_blank" rel="noopener">https://github.com/jd/tenacity</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2018/12/12/2018-12-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/12/2018-12-12/" itemprop="url">解决ssh登录ubuntu系统卡顿问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-12T10:59:00+08:00">
                2018-12-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index">
                    <span itemprop="name">系统运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<p>最近某天突然登录服务器变的很慢，输入ssh命令后大概要多10多秒钟才连上服务器（设置了免密码登录），并且登录之后切换到root用户也要等很久，网上搜索发现也有其他人遇到类似问题，尝试了网上提到的设置ssh_config和sshd_config的某些参数没有明显变化，登录服务器依旧很慢，最终发现问题还是通过自己排查，这里记录下排查过程。</p>
<p>先执行ssh命令登录服务器，增加 -v 参数打印debug信息：</p>
<blockquote>
<p>ssh -v <a href="mailto:xuqi@10.168.2.178">xuqi@10.168.2.178</a></p>
</blockquote>
<p>发现在执行到“debug1: pledge: network” 这步时卡住很久，再google一次，找到了解决办法，执行如下命令后，登录时间明显缩短到约2秒钟</p>
<blockquote>
<p>systemctl restart systemd-logind</p>
</blockquote>
<p>大致的原因是dbus服务由于某些原因重启后，也必须重启systemd服务，否则就会出现这个bug。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://serverfault.com/questions/792486/ssh-connection-takes-forever-to-initiate-stuck-at-pledge-network" target="_blank" rel="noopener">https://serverfault.com/questions/792486/ssh-connection-takes-forever-to-initiate-stuck-at-pledge-network</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2018/08/13/2018-08-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/13/2018-08-14/" itemprop="url">股指期货概念介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-13T10:40:00+08:00">
                2018-08-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%87%91%E8%9E%8D/" itemprop="url" rel="index">
                    <span itemprop="name">金融</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>股指期货（Stock Index Futures）的全称是股价指数期货，也可称为股价指数期货、期指，是指以股价指数为标的物的标准化期货合约，双方约定在未来的某个特定日期，可以按照事先确定的股价指数的大小，进行标的指数的买卖。期货分为商品期货和金融期货，股指期货属于金融期货，作为期货交易的一种类型，股指期货交易与普通商品期货交易具有基本相同的特征和流程。</p>
<h1 id="主要作用"><a href="#主要作用" class="headerlink" title="主要作用"></a>主要作用</h1><ol>
<li><p>规避投资风险</p>
<p> 当投资者不看好股市,可以通过股指期货的套期保值功能在期货上做空,锁定股票的账面盈利,从而不必将所持股票抛出,造成股市恐慌性下跌</p>
</li>
<li><p>套利</p>
<p> 所谓套利，就是利用股指期货和现货指数基差在交割日必然收敛归零的原理,当期货升水超过一定幅度时通过做空股指期货并同时买入股指期货标的指数成分股，或者当期货贴水超过一定幅度时通过做多股指期货并同时进行融券卖空股票指数ETF，来获得无风险收益。</p>
</li>
<li><p>降低股市波动性</p>
<p> 股指期货可以降低股市的日均振幅和月线平均振幅,抑制股市非理性波动,比如股指期货推出之前的五年里沪深300指数日均振幅为2.51%月线平均振幅为14.9%,推出之后的五年里日均振幅为1.95%月线平均振幅为10.7%,双双出现显著下降</p>
</li>
<li><p>丰富投资策略</p>
<p> 股指期货等金融衍生品为投资者提供了风险对冲工具，可以丰富不同的投资策略，改变目前股市交易策略一致性的现状，为投资者提供多样化的财富管理工具，以实现长期稳定的收益目标。</p>
</li>
</ol>
<h1 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h1><p>除了金融衍生产品的一般性风险外，由于标的物自身的特点和合约设计过程中的特殊性，股指期货还具有一些特定的风险。</p>
<h3 id="基差风险"><a href="#基差风险" class="headerlink" title="基差风险"></a>基差风险</h3><p>基差是某一特定地点某种商品的现货价格与同种商品的某一特定期货合约价格之间的价差。基差=现货价格-期货价格。</p>
<h3 id="合约品种差异造成的风险"><a href="#合约品种差异造成的风险" class="headerlink" title="合约品种差异造成的风险"></a>合约品种差异造成的风险</h3><p>合约品种差异造成的风险，是指类似的合约品种，如日经225种股指期货和东京证券股指期货，在相同因素的影响下，价格变动不同。表现为两种情况：<br>1〉是价格变动的方向相反。<br>2〉是价格变动的幅度不同。类似合约品种的价格，在相同因素作用下变动幅度上的差异，也构成了合约品种差异的风险。</p>
<h3 id="标的物风险"><a href="#标的物风险" class="headerlink" title="标的物风险"></a>标的物风险</h3><p>股指期货的标的物是市场上各种股票的价格总体水平，由于标的物设计的特殊性，是其特定风险无法完全锁定的原因。从套期保值的技术角度来看，商品期货、利率期货和外汇期货的套期保值者，都可以在一定期限内，通过建立现货与期货合约数量上的一致性、交易方向上的相反性来彻底锁定风险。而股指期货由于标的物的特殊性，使现货和期货合约数量上的一致仅具有理论上的意义，而不具有现实操作性。因为，股票指数设计中的综合性，以及设计中权重因素的考虑，使得在股票现货组合中，当股票品种和权数完全与指数一致时，才能真正做到完全锁定风险，而这在实际操作中的可行性几乎是零。因此，股指期货标的物的特殊性，使完全意义上的期货与现货间的套期保值成为不可能，因而风险将一直存在。</p>
<h3 id="交割制度风险"><a href="#交割制度风险" class="headerlink" title="交割制度风险"></a>交割制度风险</h3><p>股指期货采用现金交割的方式完成清算。相对于其他结合实物交割进行清算的金融衍生产品而言，存在更大的交割制度风险。如在利率期货交易中，符合规格的债券现货，无论如何也可以满足一部分交割要求。股指期货则只能是百分之百的现金交割，而不可能以对应股票完成清算。</p>
<h1 id="规则制度"><a href="#规则制度" class="headerlink" title="规则制度"></a>规则制度</h1><h3 id="合约价值"><a href="#合约价值" class="headerlink" title="合约价值"></a>合约价值</h3><p>沪深300和上证50一个点是300元，中证500是200元</p>
<h3 id="保证金"><a href="#保证金" class="headerlink" title="保证金"></a>保证金</h3><p>投资者在进行期货交易时，必须按照其买卖期货合约价值的一定比例来缴纳资金，作为履行期货合约的财力保证，然后才能参与期货合约的买卖。这笔资金就是我们常说的保证金。</p>
<p>买卖一手股指期货合约占用的保证金比例一般为合约价值的10%-20%(具体由交易所规定)，自20170918起中金所将保证金比例调整为15%，假如沪深300指数为3900点，相当于3900*300*15%=17.5万元，但在开户时账户上必须有50万的资金，完成开户验资过后留够一手保证金加上一定的余额即可，所以大致需要20万以上的资金，而中证50期指大致需要50万资金，上证50期指大致需要15万的资金。</p>
<h3 id="手续费"><a href="#手续费" class="headerlink" title="手续费"></a>手续费</h3><p>在正常情况下手续费为合约价值的万分之零点七，比如20150302沪深300指数点位为3600点，手续费为万分之零点七，即3600*300*0.00007=75元，</p>
<p>20170918起平今仓手续费调整为万分之六点九，假设沪深300指数为3900点，当天买入且当天卖出一手沪深300期指需要付出3900*300*0.00069=807元的手续费，平昨仓手续费依然是万分之零点七，即昨天买入今天卖出一手沪深300期指的手续费为3900*300*0.00007=82元，等同于变相抑制T+0。</p>
<h3 id="结算制度"><a href="#结算制度" class="headerlink" title="结算制度"></a>结算制度</h3><p>每日无负债结算制度也称为“逐日盯市”制度，简单说来，就是期货交易所要根据每日市场的价格波动对投资者所持有的合约计算盈亏并划转保证金账户中相应的资金。</p>
<p>期货交易实行分级结算，交易所首先对其结算会员进行结算，结算会员再对非结算会员及其客户进行结算。交易所在每日交易结束后，按当日结算价格结算所有未平仓合约的盈亏、交易保证金及手续费、税金等费用，对应收应付的款项同时划转，相应增加或减少会员的结算准备金。</p>
<p>交易所将结算结果通知结算会员后，结算会员再根据交易所的结算结果对非结算会员及客户进行结算，并将结算结果及时通知非结算会员及客户。若经结算，会员的保证金不足，交易所应立即向会员发出追加保证金通知，会员应在规定时间内向交易所追加保证金。若客户的保证金不足，期货公司应立即向客户发出追加保证金通知，客户应在规定时间内追加保证金。投资者可在每日交易结束后上网查询账户的盈亏，确定是否需要追加保证金或转出盈利。</p>
<h3 id="交易规则"><a href="#交易规则" class="headerlink" title="交易规则"></a>交易规则</h3><ul>
<li><p>交易时间: 周一至周五，上午：9:30-11:30，下午：13:00-15:00</p>
</li>
<li><p>涨跌幅: 上一个交易日收盘价的±10%</p>
</li>
<li><p>最大下单数</p>
<p>  中金所暂时规定限价指令每次最大下单数量为20手，市价指令每次最大下单数量为10手,进行投机交易的客户单个合约的最大持仓限额为5000手,单个账户日内交易超过20手视为过度交易行为，套期保值交易开仓数量和持仓数量不受此限.</p>
</li>
<li><p>合约代码</p>
<ul>
<li>沪深300股指期货：IF</li>
<li>中证500股指期货：IC</li>
<li>上证50股指期货：IH</li>
</ul>
</li>
<li><p>合约类型</p>
<ul>
<li><p>当月现货合约</p>
</li>
<li><p>下月</p>
</li>
<li><p>下季</p>
</li>
<li><p>隔季</p>
<p>随着每个月的交割以后，进行一次合约的滚动推进。比如在九月份，就具有九月、十月、十二月和次年三月四个合约进行交易，在十月底需要对十月合约进行交割。</p>
</li>
</ul>
</li>
<li><p>T + 0</p>
<p>  T+0即当日买进当日卖出,没有时间和次数限制,而T+1即当日买进,次日卖出,买进的当日不能当日卖出,当前期货交易一律实行T+0交易,大部分国家的股票交易也是T+0的,我国的股票市场由于历史原因而实行T+1交易制度。</p>
</li>
<li><p>卖空</p>
<p>  股指期货合约可以十分方便地卖空，等价格回落后再买回。股票融券交易也可以卖空，但难度相对较大。当然一旦卖空后价格不跌反涨，投资者会面临损失。</p>
</li>
<li><p>合约交割</p>
<p>  股票买入后可以一直持有，正常情况下股票数量不会减少。但股指期货都有固定的到期日，到期就要进行平仓或者交割。因此交易股指期货不能象买卖股票一样，交易后就不管了，必须注意合约到期日，以决定是平仓，还是等待合约到期进行现金结算交割。</p>
<p>  沪深300指数期货会在每个月第三个星期五交割，并且以沪深300现货指数截止15:00之前两个小时的算术平均价作为交割结算价，所以不论平时期货和现货的基差有多大，沪深300指数期货最终必然会强制向沪深300现货指数收敛归零，导致期货会紧跟现货指数，具有很强的联动性，就好比小狗跟着主人散步时一样，小狗有时候会跑在主人前面，有时会在主人后面，但最终前进方向是由主人决定的，套利机制就是那根狗绳。</p>
</li>
<li><p>合约结算</p>
<p>  股指期货合约采用保证金交易，一般只要付出合约面值约10-15%的资金就可以买卖一张合约，这一方面提高了盈利的空间，但另一方面也带来了风险，因此必须每日结算盈亏。买入股票后在卖出以前，账面盈亏都是不结算的。但股指期货不同，交易后每天要按照结算价对持有在手的合约进行结算，账面盈利可以提走，但账面亏损第二天开盘前必须补足（即追加保证金）。而且由于是保证金交易，亏损额甚至可能超过你的投资本金，这一点和股票交易不同。</p>
</li>
</ul>
<h3 id="基差"><a href="#基差" class="headerlink" title="基差"></a>基差</h3><p>股指期货合约与对应股票指数之间的价差，基差=现货价格-期货价格，当期货价格高于现货被称为<strong>升水</strong>，当期货价格低于现货价格被称为<strong>贴水</strong>，比如20160302 IF1603股指期货的价格为3009点，沪深300指数为3051点，基差为3051-3009=42点，2015年度沪深300股指期货主力合约与现货指数的平均基差为±1.5%，这是不太正常的，原因在于国内融资与融券的比例失衡，国外的融资和融券比例一般为3:1，而国内达到300:1以上，融资融券比例失衡致使融券套利机制无法发挥正常作用，会导致基差出现偏差。</p>
<h3 id="持仓量"><a href="#持仓量" class="headerlink" title="持仓量"></a>持仓量</h3><p>多头和空头尚未平仓的合约总数，比如20160302 IF1603合约的持仓量为3.87万手，2015年沪深300股指期货单边日均持仓量13万手，占用的(双边)保证金规模约500亿元，假设其中一半的空单是套期保值盘则对应的股票市值约700亿元，而沪深300指数300只成分股的股票总市值达20万亿以上，也就是说依靠股指期货对冲风险的股票占比还不到1%，说明国内股指期货的规模依然不够大，需降低门槛让更多的中小投资者能够参与进来.2012年，2013年，2014年，2015年，2016年每月月末平均持仓量分别为78300手，102000手，164000手，131000手，44000手，2012年成交持仓比为5.5，2013年为7.9，2014年为5.4，2015年为8.6，2016年为0.39。</p>
<h3 id="参与主体"><a href="#参与主体" class="headerlink" title="参与主体"></a>参与主体</h3><p>套期保值者、投机者、套利者</p>
<h3 id="主要策略"><a href="#主要策略" class="headerlink" title="主要策略"></a>主要策略</h3><h4 id="1-套期保值"><a href="#1-套期保值" class="headerlink" title="1. 套期保值"></a>1. 套期保值</h4><p>股指期货套期保值和其他期货套期保值一样，其基本原理是利用股指期货与股票现货之间的类似走势，通过在期货市场进行相应的操作来管理现货市场的头寸风险。</p>
<p>由于股指期货的套利操作，股指期货的价格和股票现货（股票指数）之间的走势是基本一致的，如果两者步调不一致到足够程度，就会引发套利盘入这种情况下，那么如果保值者持有一篮子股票现货，他认为当前股票市场可能会出现下跌，但如果直接卖出股票，他的成本会很高，于是他可以在股指期货市场建立空头，在股票市场出现下跌的时候，股指期货可以获利，以此可以弥补股票出现的损失。这就是所谓的<strong>空头保值</strong>。</p>
<p>另一个基本的套期保值策略是所谓的<strong>多头保值</strong>。一个投资者预期要几个月后有一笔资金投资股票市场，但他觉得如今的股票市场很有吸引力，要等上几个月的话，可能会错失建仓良机，于是他可以在股指期货上先建立多头头寸，等到未来资金到位后，股票市场确实上涨了，建仓成本提高了，但股指期货平仓获得的的盈利可以弥补现货成本的提高，于是该投资者通过股指期货锁定了现货市场的成本。</p>
<h4 id="2-投机交易"><a href="#2-投机交易" class="headerlink" title="2. 投机交易"></a>2. 投机交易</h4><p>股市指数期货提供了很高风险的机会。其中一个简单的投机策略是利用股市指数期货预测市场走势以获取利润。若预期市场价格回升，投资者便购入期货合约并预期期货合约价格将上升，相对于投资股票，其低交易成本及高杠杆比率使股票指数期货更加吸引投资者。他们亦可考虑购入那个交易月份的合约或投资于恒生指数或分类指数期货合约。</p>
<h4 id="3-套利"><a href="#3-套利" class="headerlink" title="3. 套利"></a>3. 套利</h4><p>针对股指期货与股指现货之间、股指期货不同合约之间的不合理关系进行套利的交易行为。股指期货合约是以股票价格指数作为标的物的金融期货和约，期货指数与现货指数（沪深300）维持一定的动态联系。但是，有时期货指数与现货指数会产生偏离，当这种偏离超出一定的范围时（无套利定价区间的上限和下限），就会产生套利机会。利用期指与现指之间的不合理关系进行套利的交易行为叫<strong>无风险套利（Arbitrage）</strong> ，利用期货合约价格之间不合理关系进行套利交易的称为<strong>价差交易（Spread Trading）</strong>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xuqi365.com/2018/05/25/Okex%E5%90%88%E7%BA%A6%E4%BA%A4%E6%98%93%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="eryk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Python量化交易实战">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/25/Okex%E5%90%88%E7%BA%A6%E4%BA%A4%E6%98%93%E5%85%A5%E9%97%A8/" itemprop="url">Okex合约交易基本概念介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-25T10:19:00+08:00">
                2018-05-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%87%91%E8%9E%8D/" itemprop="url" rel="index">
                    <span itemprop="name">金融</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的微信公众号：pyquant</p>
<p><img src="https://raw.githubusercontent.com/eryk/blog_img/master/20190424095328.jpg" alt=""></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>虚拟合约是合约交易的买卖对象，是由合约交易所统一制定的，规定了某一特定的时间交割一定数量商品的标准化合约。</p>
<p>OKEX的合约是OKEX推出的以BTC/LTC等币种进行结算的虚拟合约产品，每一张合约分别代表100美元的BTC，或10美元的其他币种（LTC,ETH等）,投资者可以通过买入做多合约来获取虚拟数字货币价格上涨的收益，或通过卖出做空来获取虚拟数字货币收益。合约的杠杆倍数为10或20倍。</p>
<p>OKEX在设计虚拟合约时做了相应的调整，每一张合约代表价值100美元的比特币，这样的设计使得虚拟合约的杠杆倍数始终稳定在一个固定值，从而利于套保和套利。</p>
<p>OKEX比特币虚拟合约的杠杆表现为法币收益层面的杠杆稳定：投入100美元，所能得到的收益=100美元 * 比特币的涨跌幅 * 固定的杠杆倍数。</p>
<h3 id="合约类型"><a href="#合约类型" class="headerlink" title="合约类型"></a>合约类型</h3><p>目前OKEX根据合约时间长短提供三种合约交易，分别是当周、次周、季度。</p>
<ul>
<li>当周合约：指在距离交易日最近的北京时间周五下午4点进行交割的合约。</li>
<li>次周合约：指在距离交易日最近的北京时间第二个周五下午4点进行交割的合约。</li>
<li>季度合约：指交割日为3,6,9,12月中距离当前最近的一个月份的北京时间最后一个周五下午4点进行交割的合约。</li>
</ul>
<p>新合约将于交割日当日下午16:10开始交易</p>
<h3 id="合约品种"><a href="#合约品种" class="headerlink" title="合约品种"></a>合约品种</h3><p>BTC面值为100美元，报价时的最小变动单位为0.01美元,其他币种合约的面值为10美元，报价时的最小变动单位为0.001美元</p>
<p>BTC、LTC、ETH、ETC、BCH、XRP、EOS、BTG</p>
<h3 id="交易规则"><a href="#交易规则" class="headerlink" title="交易规则"></a>交易规则</h3><p>买入开多，卖出开空，买入平空，卖出平多</p>
<p>开仓:</p>
<pre><code>未实现盈亏的计算公式：多仓未实现盈亏=（合约面值 / 结算基准价 - 合约面值 / 当前价格）* 持仓数量； 空仓未实现盈亏=（合约面值 / 当前价格 - 合约面值 / 结算基准价）* 持仓数量 </code></pre><p>平仓:</p>
<pre><code>已实现盈亏的计算公式：多仓已实现盈亏=（合约面值 / 结算基准价 -合约面值 /平仓价格） * 平仓数量； 空仓已实现盈亏=（合约面值 / 平仓价格-合约面值 /结算基准价）* 平仓数量 </code></pre><h3 id="风控规则"><a href="#风控规则" class="headerlink" title="风控规则"></a>风控规则</h3><ul>
<li>全仓保证金制度、逐仓保证金制度、限价爆仓制度</li>
<li>全仓保证金制度与逐仓保证金制度，投资者二者只能选其一</li>
<li>全仓保证金: 当用户选择全仓保证金时，用户转入虚拟合约账户的所有余额，所有合约产生的盈亏都将作为合约的持仓保证金</li>
</ul>
<blockquote>
<p>全仓保证金模式下，开仓的要求是10倍杠杆开仓后，保证金率不低于90%，20倍杠杆开仓后，保证金率不低于80%</p>
</blockquote>
<p>所有虚拟合约账户中的BTC和LTC都将作为虚拟合约持仓的保证金，保证金数量将会随价格变化而变动。当虚拟合约价格朝着不利于投资者方向运动时，账户权益即会发生损失。当用户的保证金率变为0%时，账户即被爆仓，此时被爆仓的用户的损失接近或等于其虚拟合约账户中的所有资产。用户通过转入保证金和开仓合约的数量调整时机杠杆倍数。转入的保证金越多，开仓的合约数量越少，虚拟合约的实际杠杆倍数即越小，越不容易被爆仓。 </p>
<p>用户的保证金率=用户所有保证金/用户持仓所需的保证金-调整系数。在10倍杠杆时，合约的调整系数=10%，20倍杠杆时，合约的调整系数=20%；当保证金率小于等于0时，账户将被爆仓，所有仓位将被限价强平，未能强平的委托将在交割时进行爆仓分摊</p>
<ul>
<li><p>逐仓保证金制度：</p>
<p>  用户在合约开仓时所需要的保证金作为虚拟合约持仓的固定保证金，当虚拟合约价格发生变化时，保证金数值不发生变化。当虚拟合约价格朝向不利于用户方向运动时，未实现盈亏将发生损失。当用户的该合约该仓位的保证金率((固定保证金+未实现盈亏) * 开仓均价 * 杠杆 / (合约面值 * 持仓数量) - 调整系数；10倍杠杆，合约的调整系数=10%；20倍杠杆，合约的调整系数=20%，保证金率小于等于0%时，该合约的该仓位将被爆仓，此时被爆仓的用户损失接近或等于其该合约该方向仓位下的固定保证金。</p>
</li>
</ul>
<blockquote>
<p>采用逐仓保证金模式时，每个合约的双向持仓将会独立计算其保证金和收益，只有开仓可用保证金大于等于开仓所需的保证金数量，用户才能进行委托。而逐仓保证金时，每个合约的开仓可用保证金可能不一致。 </p>
</blockquote>
<h3 id="委托方式"><a href="#委托方式" class="headerlink" title="委托方式"></a>委托方式</h3><h5 id="1-计划委托"><a href="#1-计划委托" class="headerlink" title="1. 计划委托"></a>1. 计划委托</h5><p>计划委托指令指的是预先设置委托和触发条件，当最新的成交价格达到事先设定的触发价格时，即会将事先设置的委托送入市场。 </p>
<h5 id="2-跟踪委托"><a href="#2-跟踪委托" class="headerlink" title="2. 跟踪委托"></a>2. 跟踪委托</h5><p>跟踪委托指的是在行情发生较大幅度回调的情况下，将客户事先设定的委托送入市场的策略。当市场的最新价格达到投资者设定该策略后最高（最低）市场价格的（1±客户设定回调幅度）后，即会触发客户设定的策略，将客户事先设定的委托送入市场中。 </p>
<h5 id="3-冰山委托"><a href="#3-冰山委托" class="headerlink" title="3. 冰山委托"></a>3. 冰山委托</h5><p>冰山委托指的是投资者在进行大额交易时，为避免对市场造成过大冲击，将大单委托自动拆为多笔委托，根据当前的最新买一/卖一价格和客户设定的价格策略自动进行小单委托，在上一笔委托被全部成交或最新价格明显偏离当前委托价时，自动重新进行委托。 </p>
<h5 id="4-时间加权委托"><a href="#4-时间加权委托" class="headerlink" title="4. 时间加权委托"></a>4. 时间加权委托</h5><p>时间加权委托指的是客户希望大额交易BTC时，为避免过大冲击成本，通过策略将大单拆细为多个小额委托，根据最新的对手方委托量自动选择委托量，主动与对手方成交进行连续买入的策略。 </p>
<h3 id="保证金制度"><a href="#保证金制度" class="headerlink" title="保证金制度"></a>保证金制度</h3><ul>
<li>10倍</li>
<li>20倍</li>
</ul>
<h3 id="手续费"><a href="#手续费" class="headerlink" title="手续费"></a>手续费</h3><p>开仓和平仓都征收手续费；若 maker 的手续费为负数，意味着您主动挂单为合约提供流动性，平台将赠送您手续费。合约交割手续费不受用户等级影响(BTC收取0.015%，非BTC收取0.05%)；爆仓导致的平仓不收手续费。</p>
<p>等级 近30天交易量(BTC) 挂单成交手续费 吃单成交手续费</p>
<p>Lv1 &lt;10000 0.03% 0.05%</p>
<p>Lv2 ≥10000 0.025% 0.045%</p>
<p>Lv3 ≥20000 0.02% 0.04%</p>
<p>Lv4 ≥30000 0.015% 0.035%</p>
<p>Lv5 ≥60000 0.01% 0.03%</p>
<p>Lv6 ≥100000 0.005% 0.025%</p>
<p>Lv7 ≥200000 0% 0.02%</p>
<p>Lv8 ≥300000 -0.01% 0.02%</p>
<h3 id="借币利息"><a href="#借币利息" class="headerlink" title="借币利息"></a>借币利息</h3><ul>
<li><p>计息规则：单笔借币订单独立计息。借币成功时首次计息，之后满24小时计息一次。每满15天，系统将未还清借币进行复息结算（未还利息计入下一阶段本金中），并开始下一阶段计息。</p>
</li>
<li><p>还币规则：优先还最早生成的借币订单。优先还利息，再还本金。单笔借币订单的本金和应还利息全部还清后，单笔借币订单状态转换为已还清，随后此订单不再计息。</p>
</li>
</ul>
<p>借币日息usdt eth btc 0.1%，其他0.02%，不满一天按一天算</p>
<h3 id="爆仓"><a href="#爆仓" class="headerlink" title="爆仓"></a>爆仓</h3><p>用户资产：本金+已借-已产生的利息</p>
<p>负债：所有“已借”资产</p>
<p>风险率=用户资产/负债</p>
<p>当风险率跌到130%将有短信提示接近爆仓水平；当风险率跌到110%单仓将被强平。</p>
<p>风险率：评估币币杠杆账户爆仓风险的指标。当风险率≥150%时，账户中多余的资产部分可通过资金划转转出；当风险率≤130%，风险率评估为风险，系统会给用户发短信提示风险；当风险率≤110%，系统将强制爆仓，并发短信告知用户。</p>
<p>风险率计算公式：风险率=[(计价货币总资产-计价货币未还利息)/最新成交价+(交易货币总资产-交易货币未还利息)]/(计价货币借入资产/最新成交价+交易货币借入资产)*100%</p>
<p>爆仓：当某币币杠杆账户的风险率≤110%时，系统会执行爆仓操作，使用该账户内所有资产去偿还借币债务。</p>
<p>爆仓风险率=110%</p>
<p>预计爆仓价格：在OKEx.com每一笔借币均须交纳一定比例的保证金，当市场发生不利变化，比如市场发生行情逆转，朝相反方向变化时，当前币币杠杆账户总资产缩水到一定限度时，系统会强制将该币币杠杆账户资产按市场最优价格以挂单形式卖出清算借币以及利息。</p>
<p>预计爆仓价格计算公式：预计爆仓价格=(计价货币借入资产*爆仓风险率+计价货币未还利息-计价货币总资产)/(交易货币总资产-交易货币未还利息-交易货币借入资产*爆仓风险率)</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>合约限价机制</p>
<ul>
<li>新合约生成10分钟内：最高价=现货指数（1+5%），最低价=现货指数（1-5%）。</li>
<li>合约生成了10分钟后：最高价=近10分钟溢价平均值+现货指数（1+3%）,最低价=近10分钟溢价均值+现货指数（1-3%），溢价=合约价格-现货价格。<br>若计算后的价格超过最高偏离度的现货指数25%或价格小于0，则最高价=现货指数（1+25%），最低价=现货指数（1-25%）。</li>
<li>以上规则，开平仓都受限制，若开多或平空，当委托价高于最高价，则将触发限价；若开空或平多，当委托价低于最新价，则将触发限价。</li>
</ul>
<h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><p>清算已实现盈亏：</p>
<p>每周五下午4:00会进行清结算，需要每个合约的本周已实现盈亏结转到用户余额中，此部分金额可以用于开仓和提现。</p>
<p>清算未实现盈亏：</p>
<p>每周五下午4:00会进行清结算，若用户持有次周，季度合约的仓位，则需将仓位中未实盈亏结转到已实现盈亏中。</p>
<p>爆仓平多/平空：</p>
<p>逐仓：当用户将仓位中的”已用保证金“亏完时，则该仓位会被爆仓，系统将该持仓进行强制平仓.</p>
<p>全仓：当用户将账户权益（存入金额+已实现盈亏+未实现盈亏）亏损完后，系统将用户的所有持仓进行强制平仓。</p>
<p>交割平多/交割平空：</p>
<p>当合约到期时（如每周五下午4:00当周合约到期），系统以最近一小时现货指数的算术平均值作为交割价对所有开仓的合约进行交割平仓，交割平仓后产生的盈亏部分加入已实现盈亏。</p>
<p>爆仓平仓剩余：</p>
<p>当用户爆仓时，系统会按爆仓价格进行强制平仓，但在撮合成交时可能与爆仓价格有所偏差，价格偏差所导致的盈余则称之为爆仓平仓剩余。</p>
<p>穿仓分摊：</p>
<p>当市场行情波动较大，用户爆仓后，按照爆仓价格无法成交时，导致亏损范围大于保证金。因此OKEX平台采用“分摊”制度，从本周盈利的用户中，每个人等比例分摊穿仓部分的损失。</p>
<h4 id="合约爆仓问题"><a href="#合约爆仓问题" class="headerlink" title="合约爆仓问题"></a>合约爆仓问题</h4><p><a href="https://support.okex.com/hc/zh-cn/articles/360000139652-%E5%90%88%E7%BA%A6%E7%88%86%E4%BB%93%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">https://support.okex.com/hc/zh-cn/articles/360000139652-%E5%90%88%E7%BA%A6%E7%88%86%E4%BB%93%E9%97%AE%E9%A2%98</a></p>
<h4 id="合约结算交割问题"><a href="#合约结算交割问题" class="headerlink" title="合约结算交割问题"></a>合约结算交割问题</h4><p>交割规则有关于穿仓的介绍</p>
<p><a href="https://support.okex.com/hc/zh-cn/articles/360000105511-%E5%90%88%E7%BA%A6%E7%BB%93%E7%AE%97%E4%BA%A4%E5%89%B2%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">https://support.okex.com/hc/zh-cn/articles/360000105511-%E5%90%88%E7%BA%A6%E7%BB%93%E7%AE%97%E4%BA%A4%E5%89%B2%E9%97%AE%E9%A2%98</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">eryk</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">51</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">54</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">eryk</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
